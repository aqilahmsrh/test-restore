name: Restore MySQL Database

on:

  workflow_dispatch:
    inputs:
      # version:
      #   description: 'Repo Tag Name (Ex.: yyyymmdd-hhmmss)'
      #   type: string
      #   required: true
      environment:
        description: 'test'
        type: string
        required: true

jobs:

  DEXSIT-backup:
    if: inputs.environment == 'test'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3
      
      - name: Upload to AWS S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.DEVOPS_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.DEVOPS_AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
          BUCKET_NAME: s3://bucket-test-777/backup-db/
        run: |
          aws s3 cp test.txt $BUCKET_NAME

      - name: Generate S3 Object URL
        id: generate-s3-url
        run: |
          S3_OBJECT_URL="s3://${{ secrets.AWS_BUCKET_NAME }}/test.txt"
          # Generate a pre-signed URL valid for 1 hour (adjust the expiration time as needed)
          DOWNLOAD_URL=$(aws s3 presign $S3_OBJECT_URL --expires-in 3600 --region ${{ secrets.AWS_REGION }} --endpoint-url https://bucket-test-777.s3.ap-southeast-1.amazonaws.com)
          echo "DOWNLOAD_URL=$DOWNLOAD_URL" >> $GITHUB_ENV

      - name: Echo S3 Object URL
        run: |
          echo "Download link for the uploaded object: $DOWNLOAD_URL"
